<script>
  /* ---------- API Endpoints ---------- */
  const API = {
    countries: "https://test.amrita-fashions.com/api/countries",
    states: "https://test.amrita-fashions.com/api/states",
    cities: "https://test.amrita-fashions.com/api/cities",
    locations: "https://test.amrita-fashions.com/api/locations",
  };

  /* ---------- DOM Elements (cached after DOMContentLoaded) ---------- */
  let modalEl;
  let overlayEl;

  /* ---------- Data & State ---------- */
  let countries = [];
  let states = [];
  let cities = [];
  let locations = [];

  let selectedCountry = null;
  let selectedState = null;
  let selectedCity = null;

  let currentLevel = "countries"; // 'countries', 'states', 'cities', 'locations'
  let isLoading = false;
  let isModalOpen = false;

  /* ---------- Helpers ---------- */
  const getId = (item) =>
    item?._id ?? item?.id ?? item?.slug ?? item?.code ?? null;

  const getName = (item) =>
    item?.name ??
    item?.title ??
    item?.cityName ??
    item?.stateName ??
    item?.countryName ??
    item?.locationName ??
    "Unnamed";

  const getCountryFromState = (state) => state?.country ?? null;
  const getStateFromCity = (city) => city?.state ?? null;
  const getCityFromLocation = (loc) => loc?.city ?? null;

  function slugify(value) {
    return String(value || "")
      .trim()
      .toLowerCase()
      .replace(/['‚Äô]/g, "")
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/^-+|-+$/g, "");
  }

  function getSlugForUrl(item) {
    if (!item) return null;
    if (item.slug) return String(item.slug).toLowerCase();
    if (item.code) return String(item.code).toLowerCase();
    const name = getName(item);
    return slugify(name);
  }

  async function fetchJson(url) {
    isLoading = true;
    updateUI();
    try {
      const res = await fetch(url, { headers: { Accept: "application/json" } });
      if (!res.ok) return [];
      const json = await res.json();

      // Smartly parse the JSON response structure
      if (Array.isArray(json)) return json;
      const data = json?.data;
      if (data && typeof data === "object") {
        if (Array.isArray(data.countries)) return data.countries;
        if (Array.isArray(data.states)) return data.states;
        if (Array.isArray(data.cities)) return data.cities;
        if (Array.isArray(data.locations)) return data.locations;
        if (Array.isArray(data.items)) return data.items;
        for (const key of Object.keys(data)) {
          if (Array.isArray(data[key])) return data[key];
        }
      }
      if (json && typeof json === "object") {
        if (Array.isArray(json.data)) return json.data;
        if (Array.isArray(json.items)) return json.items;
        if (Array.isArray(json.countries)) return json.countries;
        if (Array.isArray(json.states)) return json.states;
        if (Array.isArray(json.cities)) return json.cities;
        if (Array.isArray(json.locations)) return json.locations;
      }

      return [];
    } catch (err) {
      console.error("Error fetching", url, err);
      return [];
    } finally {
      isLoading = false;
      updateUI();
    }
  }

  /* ---------- State Management / URL Sync ---------- */

  // Read current selection from URL hash, using slugs
  function deriveStateFromUrl() {
    const url = new URL(window.location.href);
    const params = new URLSearchParams(url.hash.slice(1));

    const cSlug = (params.get("c") || "").toLowerCase();
    const sSlug = (params.get("s") || "").toLowerCase();
    const tSlug = (params.get("t") || "").toLowerCase();

    const matchBySlug = (list, slug) =>
      list.find((item) => getSlugForUrl(item) === slug) || null;

    selectedCountry = cSlug ? matchBySlug(countries, cSlug) : null;
    selectedState = sSlug ? matchBySlug(states, sSlug) : null;
    selectedCity = tSlug ? matchBySlug(cities, tSlug) : null;

    if (selectedCity) {
      currentLevel = "locations";
    } else if (selectedState) {
      currentLevel = "cities";
    } else if (selectedCountry) {
      currentLevel = "states";
    } else {
      currentLevel = "countries";
    }

    // Keep navbar flag/code in sync
    if (selectedCountry && selectedCountry.code) {
      try {
        const code = selectedCountry.code.toUpperCase();
        localStorage.setItem("selectedCountry", code);
        if (window.updateHeaderDisplay) {
          window.updateHeaderDisplay(code);
        }
      } catch (e) {}
    }

    updateUI();
  }

  // Sync selection to URL hash using slugs (no reload)
  function updateUrlHash(level, value) {
    const url = new URL(window.location.href);
    const params = new URLSearchParams(url.hash.slice(1));

    const valueSlug = getSlugForUrl(value) || "";

    if (level === "country") {
      if (valueSlug) params.set("c", valueSlug);
      else params.delete("c");
      params.delete("s");
      params.delete("t");
    } else if (level === "state") {
      if (valueSlug) params.set("s", valueSlug);
      else params.delete("s");
      params.delete("t");
    } else if (level === "city") {
      if (valueSlug) params.set("t", valueSlug);
      else params.delete("t");
    } else if (level === "clear") {
      params.delete("c");
      params.delete("s");
      params.delete("t");
    }

    const newHash = params.toString() ? "#" + params.toString() : "";
    history.replaceState(null, "", url.pathname + newHash);
  }

  function openModal() {
    if (!modalEl || !overlayEl) return;

    isModalOpen = true;
    modalEl.classList.add("open");
    overlayEl.classList.add("open");
    document.body.style.overflow = "hidden";
  }

  function closeModal() {
    if (!modalEl || !overlayEl) return;

    isModalOpen = false;
    modalEl.classList.remove("open");
    overlayEl.classList.remove("open");
    document.body.style.overflow = "";

    // Only strip `/market-area` segment if it is actually present in the path
    const currentUrl = new URL(window.location.href);
    if (/\/market-area\/?$/.test(currentUrl.pathname)) {
      let newPath = currentUrl.pathname.replace(/\/market-area\/?$/, "/");
      if (newPath === "") newPath = "/";
      window.location.href = newPath + currentUrl.hash;
    }
  }

  /* ---------- Handlers ---------- */
  function handleCountryClick(country) {
    selectedCountry = country;
    selectedState = null;
    selectedCity = null;
    currentLevel = "states";
    updateUrlHash("country", country);
    updateUI();
  }

  function handleStateClick(state) {
    selectedState = state;
    selectedCity = null;
    currentLevel = "cities";
    updateUrlHash("state", state);
    updateUI();
  }

  function handleCityClick(city) {
    selectedCity = city;
    currentLevel = "locations";
    updateUrlHash("city", city);
    updateUI();
  }

  function handleClearAll() {
    selectedCountry = null;
    selectedState = null;
    selectedCity = null;
    currentLevel = "countries";
    updateUrlHash("clear");
    updateUI();
  }

  function handleBack() {
    if (currentLevel === "locations") {
      selectedCity = null;
      currentLevel = "cities";
      updateUrlHash("state", selectedState);
    } else if (currentLevel === "cities") {
      selectedState = null;
      currentLevel = "states";
      updateUrlHash("country", selectedCountry);
    } else if (currentLevel === "states") {
      selectedCountry = null;
      currentLevel = "countries";
      updateUrlHash("clear");
    }
    updateUI();
  }

  function handleBreadcrumbClick(level) {
    if (level === currentLevel) return;

    if (level === "countries") {
      handleClearAll();
    } else if (level === "states") {
      selectedState = null;
      selectedCity = null;
      currentLevel = "states";
      updateUrlHash("country", selectedCountry);
    } else if (level === "cities") {
      selectedCity = null;
      currentLevel = "cities";
      updateUrlHash("state", selectedState);
    }
    updateUI();
  }

  function createItemElement(item, isActive, onClick, level) {
    const itemEl = document.createElement("button");
    itemEl.className = `location-item ${isActive ? "active" : ""}`;
    itemEl.dataset.level = level;
    itemEl.type = "button";

    const textEl = document.createElement("span");
    textEl.className = "item-text";
    textEl.textContent = getName(item);

    const arrowEl = document.createElement("span");
    arrowEl.className = "item-arrow";
    arrowEl.innerHTML = "‚Üí";

    itemEl.appendChild(textEl);
    if (level !== "locations") {
      itemEl.appendChild(arrowEl);
    }

    if (onClick) {
      itemEl.addEventListener("click", () => onClick(item));
      itemEl.addEventListener("mouseenter", () =>
        itemEl.classList.add("hover")
      );
      itemEl.addEventListener("mouseleave", () =>
        itemEl.classList.remove("hover")
      );
    }

    return itemEl;
  }

  function renderItems(container, items, activeItem, onClick, level) {
    if (!container) return;

    container.innerHTML = "";

    if (!items || items.length === 0) {
      const emptyEl = document.createElement("div");
      emptyEl.className = "empty-state";
      emptyEl.innerHTML = `
        <div class="empty-icon">üì≠</div>
        <div class="empty-text">No ${level} available</div>
      `;
      container.appendChild(emptyEl);
      return;
    }

    const activeId = activeItem ? getId(activeItem) : null;

    items.forEach((item) => {
      const isActive =
        activeId && getId(item) && String(getId(item)) === String(activeId);
      const itemEl = createItemElement(item, isActive, onClick, level);
      container.appendChild(itemEl);
    });
  }

  /* ---------- UI Rendering ---------- */
  function updateUI() {
    const countryListEl = document.getElementById("country-list-modal");
    const stateListEl = document.getElementById("state-list-modal");
    const cityListEl = document.getElementById("city-list-modal");
    const locationListEl = document.getElementById("location-list-modal");

    const statesSection = document.getElementById("states-section-modal");
    const citiesSection = document.getElementById("cities-section-modal");
    const locationsSection = document.getElementById("locations-section-modal");

    const selectedCountryValue = document.getElementById(
      "selected-country-value-modal"
    );
    const selectedStateValue = document.getElementById(
      "selected-state-value-modal"
    );
    const selectedCityValue = document.getElementById(
      "selected-city-value-modal"
    );
    const clearAllBtn = document.getElementById("clear-all-btn-modal");
    const backBtn = document.getElementById("back-btn-modal");
    const breadcrumbEl = document.getElementById("breadcrumb-modal");

    const loadingSection = document.getElementById("loading-section-modal");
    if (loadingSection)
      loadingSection.classList.toggle("hidden", !isLoading);

    const countriesSection = document.getElementById("countries-section-modal");
    if (countriesSection) countriesSection.classList.toggle("hidden", false);
    if (statesSection)
      statesSection.classList.toggle(
        "hidden",
        !selectedCountry || currentLevel === "countries"
      );
    if (citiesSection)
      citiesSection.classList.toggle(
        "hidden",
        !selectedState || currentLevel === "states"
      );
    if (locationsSection)
      locationsSection.classList.toggle(
        "hidden",
        !selectedCity || currentLevel === "cities"
      );

    // --- Breadcrumb ---
    if (breadcrumbEl) {
      breadcrumbEl.innerHTML = "";
      const levels = [
        { level: "countries", icon: "üåç", text: "All Countries", data: null },
        {
          level: "states",
          icon: "üó∫Ô∏è",
          text: getName(selectedCountry),
          data: selectedCountry,
        },
        {
          level: "cities",
          icon: "üèôÔ∏è",
          text: getName(selectedState),
          data: selectedState,
        },
        {
          level: "locations",
          icon: "üìç",
          text: getName(selectedCity),
          data: selectedCity,
        },
      ].filter((item) => item.data || item.level === "countries");

      levels.forEach((item, index) => {
        const itemEl = document.createElement("button");
        itemEl.className = `breadcrumb-item ${
          item.level === currentLevel ? "active" : ""
        }`;
        itemEl.innerHTML = `<span class="breadcrumb-icon">${item.icon}</span><span class="breadcrumb-text">${item.text}</span>`;
        itemEl.onclick = () => handleBreadcrumbClick(item.level);

        if (index > 0) {
          const connector = document.createElement("span");
          connector.className = "breadcrumb-connector";
          connector.innerHTML = "‚Ä∫";
          breadcrumbEl.appendChild(connector);
        }
        breadcrumbEl.appendChild(itemEl);
      });
    }

    // --- Summary / Actions ---
    const hasSelection = selectedCountry || selectedState || selectedCity;
    if (selectedCountryValue)
      selectedCountryValue.textContent = selectedCountry
        ? getName(selectedCountry)
        : "None";
    if (selectedStateValue)
      selectedStateValue.textContent = selectedState
        ? getName(selectedState)
        : "None";
    if (selectedCityValue)
      selectedCityValue.textContent = selectedCity
        ? getName(selectedCity)
        : "None";
    if (clearAllBtn) clearAllBtn.disabled = !hasSelection;
    if (backBtn) backBtn.disabled = currentLevel === "countries";

    // Keep navbar display in sync whenever country changes
    if (selectedCountry && selectedCountry.code) {
      try {
        const code = selectedCountry.code.toUpperCase();
        localStorage.setItem("selectedCountry", code);
        if (window.updateHeaderDisplay) {
          window.updateHeaderDisplay(code);
        }
      } catch (e) {}
    }

    // --- Dynamic section headings ---
    const statesTitleEl = document.getElementById("states-title");
    const statesSubtitleEl = document.getElementById("states-subtitle");
    const citiesTitleEl = document.getElementById("cities-title");
    const citiesSubtitleEl = document.getElementById("cities-subtitle");
    const locationsTitleEl = document.getElementById("locations-title");
    const locationsSubtitleEl = document.getElementById("locations-subtitle");

    if (statesTitleEl) {
      const countryName = selectedCountry ? getName(selectedCountry) : "";
      statesTitleEl.textContent = countryName
        ? `States in ${countryName}`
        : "States";
    }
    if (statesSubtitleEl) {
      statesSubtitleEl.textContent =
        "Select a state to view its cities";
    }

    if (citiesTitleEl) {
      const stateName = selectedState ? getName(selectedState) : "";
      citiesTitleEl.textContent = stateName
        ? `Cities in ${stateName}`
        : "Cities";
    }
    if (citiesSubtitleEl) {
      citiesSubtitleEl.textContent =
        "Select a city to view its locations";
    }

    if (locationsTitleEl) {
      const cityName = selectedCity ? getName(selectedCity) : "";
      locationsTitleEl.textContent = cityName
        ? `Market Locations in ${cityName}`
        : "Market Locations";
    }
    if (locationsSubtitleEl) {
      locationsSubtitleEl.textContent =
        "Available market areas and locations";
    }

    // --- Item Lists ---
    renderItems(countryListEl, countries, selectedCountry, handleCountryClick, "countries");

    if (selectedCountry) {
      const visibleStates = states.filter((s) => {
        const c = getCountryFromState(s);
        const cid = getId(c);
        return (
          cid &&
          getId(selectedCountry) &&
          String(cid) === String(getId(selectedCountry))
        );
      });
      renderItems(stateListEl, visibleStates, selectedState, handleStateClick, "states");
    }

    if (selectedState) {
      const visibleCities = cities.filter((c) => {
        const s = getStateFromCity(c);
        const sid = getId(s);
        return (
          sid &&
          getId(selectedState) &&
          String(sid) === String(getId(selectedState))
        );
      });
      renderItems(cityListEl, visibleCities, selectedCity, handleCityClick, "cities");
    }

    if (selectedCity) {
      const visibleLocations = locations.filter((loc) => {
        const c = getCityFromLocation(loc);
        const cid = getId(c);
        return (
          cid &&
          getId(selectedCity) &&
          String(cid) === String(getId(selectedCity))
        );
      });
      renderItems(locationListEl, visibleLocations, null, null, "locations");
    }
  }

  /* ---------- Initialization ---------- */

  async function initMarketPage() {
    if (!modalEl || !overlayEl) {
      return;
    }

    if (countries.length === 0) {
      const [countriesData, statesData, citiesData, locationsData] =
        await Promise.all([
          fetchJson(API.countries),
          fetchJson(API.states),
          fetchJson(API.cities),
          fetchJson(API.locations),
        ]);

      countries = countriesData || [];
      states = statesData || [];
      cities = citiesData || [];
      locations = locationsData || [];
    }

    deriveStateFromUrl();
    updateUI();
  }

  /* ---------- Event Listeners and Observers ---------- */

  function handlePopState() {
    const isModalPath = window.location.pathname.endsWith("/market-area");
    if (isModalPath && !isModalOpen) {
      openModal();
    } else if (!isModalPath && isModalOpen) {
      isModalOpen = false;
      if (modalEl) modalEl.classList.remove("open");
      if (overlayEl) overlayEl.classList.remove("open");
      document.body.style.overflow = "";
    }
    // Always sync from hash on history navigation
    deriveStateFromUrl();
  }

  document.addEventListener("DOMContentLoaded", () => {
    modalEl = document.getElementById("market-area-modal");
    overlayEl = document.getElementById("market-modal-overlay");

    // Make modal globally openable from navbar
    window.openMarketAreaModal = () => {
      openModal();
      initMarketPage();
    };

    document
      .getElementById("clear-all-btn-modal")
      ?.addEventListener("click", handleClearAll);
    document
      .getElementById("back-btn-modal")
      ?.addEventListener("click", handleBack);
    document
      .getElementById("retry-btn-modal")
      ?.addEventListener("click", initMarketPage);
    document
      .getElementById("modal-close-btn")
      ?.addEventListener("click", closeModal);
    overlayEl?.addEventListener("click", closeModal);

    const isModalPath = window.location.pathname.endsWith("/market-area");
    if (isModalPath) {
      openModal();
    }
    initMarketPage();
  });

  window.addEventListener("popstate", handlePopState);
</script>

<div
  id="market-modal-overlay"
  class="market-modal-overlay"
  aria-hidden="true"
></div>
<dialog
  id="market-area-modal"
  class="market-modal"
  role="dialog"
  aria-modal="true"
  aria-label="Select Market Area"
>
  <div class="modal-header">
    <h2 class="modal-title">Select Market Area</h2>
    <button
      id="modal-close-btn"
      class="modal-close-btn"
      aria-label="Close Market Area Selection"
    >
      &times;
    </button>
  </div>

  <div class="market-page-content">
    <div class="breadcrumb-container-modal">
      <div class="breadcrumb-modal" id="breadcrumb-modal"></div>
    </div>

    <div class="main-container-modal">
      <div class="loading-section hidden" id="loading-section-modal">
        <div class="loading-spinner"></div>
        <p>Loading locations...</p>
      </div>

      <div class="selection-summary-modal has-selection">
        <div class="summary-item">
          <span class="summary-label">Country:</span>
          <span
            class="summary-value"
            id="selected-country-value-modal"
            >None</span
          >
        </div>
        <div class="summary-item">
          <span class="summary-label">State:</span>
          <span
            class="summary-value"
            id="selected-state-value-modal"
            >None</span
          >
        </div>
        <div class="summary-item">
          <span class="summary-label">City:</span>
          <span
            class="summary-value"
            id="selected-city-value-modal"
            >None</span
          >
        </div>

        <div class="quick-actions-modal">
          <button class="action-btn" id="back-btn-modal" disabled>
            <span class="action-icon">‚Ü©Ô∏è</span>
            Back
          </button>
          <button class="action-btn clear-btn" id="clear-all-btn-modal" disabled>
            <span class="action-icon">üóëÔ∏è</span>
            Clear All
          </button>
        </div>
      </div>

      <section class="category-section" id="countries-section-modal">
        <div class="section-header">
          <div class="header-text">
            <h2>Countries</h2>
            <p>Select a country to explore its regions</p>
          </div>
        </div>
        <div class="items-grid" id="country-list-modal"></div>
      </section>

      <section class="category-section hidden" id="states-section-modal">
        <div class="section-header">
          <div class="header-text">
            <h2 id="states-title">States</h2>
            <p id="states-subtitle">Select a state to view its cities</p>
          </div>
        </div>
        <div class="items-grid" id="state-list-modal"></div>
      </section>

      <section class="category-section hidden" id="cities-section-modal">
        <div class="section-header">
          <div class="header-text">
            <h2 id="cities-title">Cities</h2>
            <p id="cities-subtitle">Select a city to view its locations</p>
          </div>
        </div>
        <div class="items-grid" id="city-list-modal"></div>
      </section>

      <section class="category-section hidden" id="locations-section-modal">
        <div class="section-header">
          <div class="header-text">
            <h2 id="locations-title">Market Locations</h2>
            <p id="locations-subtitle">
              Available market areas and locations
            </p>
          </div>
        </div>
        <div class="items-grid" id="location-list-modal"></div>
      </section>
    </div>
  </div>
</dialog>



<style>
/* Scoped variables for the modal UI */
:root {
    --primary: #3b82f6;
    --primary-dark: #2563eb;
    --primary-light: #dbeafe;
    --primary-lighter: #eff6ff;
    --background: #f8fafc;
    --surface: #ffffff;
    --text-primary: #1f2937;
    --text-secondary: #6b7280;
    --text-muted: #9ca3af;
    --border: #e5e7eb;
    --border-light: #f3f4f6;
    --radius: 12px;
}

/* --- MODAL SPECIFIC STYLES --- */
.market-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease;
}
.market-modal-overlay.open {
    opacity: 1;
    visibility: visible;
}

.market-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    width: min(95vw, 1000px);
    max-height: 90vh;
    padding: 0;
    border: none;
    border-radius: 16px;
    background: var(--surface);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
    z-index: 1001;
    overflow: hidden;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}
.market-modal.open {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
    pointer-events: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border);
    background: var(--primary-lighter);
}

.modal-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary-dark);
}

.modal-close-btn {
    background: none;
    border: none;
    font-size: 2rem;
    cursor: pointer;
    color: var(--text-secondary);
    line-height: 1;
    transition: color 0.2s ease, transform 0.2s ease;
}
.modal-close-btn:hover {
    color: var(--primary);
    transform: rotate(90deg);
}

.market-page-content {
    max-height: calc(90vh - 58px); /* 58px is approx header height */
    overflow-y: auto;
    padding-bottom: 1rem;
}

/* Breadcrumb Styling */
.breadcrumb-container-modal {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 0.75rem 1.5rem;
}

.breadcrumb-modal {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.breadcrumb-modal .breadcrumb-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 0.8rem;
    background: var(--background);
    border-radius: 16px;
    font-size: 0.85rem;
    color: var(--text-secondary);
    transition: all 0.2s ease;
    cursor: pointer;
    border: 1px solid transparent;
}

.breadcrumb-modal .breadcrumb-item:not(.active):hover {
    background: var(--primary-light);
    color: var(--primary-dark);
}

.breadcrumb-modal .breadcrumb-item.active {
    background: var(--primary);
    color: white;
    font-weight: 600;
}

.breadcrumb-modal .breadcrumb-connector {
    color: var(--text-muted);
    font-weight: 600;
}

/* Main Container */
.main-container-modal {
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

/* Selection Summary */
.selection-summary-modal {
    background: var(--primary-lighter);
    border: 1px solid var(--primary-light);
    border-radius: var(--radius);
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}
.summary-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.3rem 0.6rem;
    background: white;
    border-radius: 6px;
    border: 1px solid var(--primary-light);
}
.summary-label {
    font-size: 0.8rem;
    color: var(--text-secondary);
    font-weight: 500;
}
.summary-value {
    font-size: 0.8rem;
    color: var(--primary-dark);
    font-weight: 600;
}
.quick-actions-modal {
    display: flex;
    gap: 0.5rem;
}

.action-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-secondary);
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}
.action-btn:hover:not(:disabled) {
    background: var(--primary-light);
    color: var(--primary-dark);
    border-color: var(--primary);
}
.action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Category Sections */
.category-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
}
.category-section.hidden {
    display: none;
}
.section-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem 1.5rem;
    border-bottom: 1px solid var(--border);
}
.header-text {
    flex: 1;
}
.header-text h2 {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
}
.header-text p {
    color: var(--text-secondary);
    font-size: 0.85rem;
}

/* Items Grid */
.items-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    padding: 1rem 1.5rem;
    gap: 0.75rem;
}

/* Location Items */
.location-item {
    background: var(--surface);
    border: 2px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
}
.location-item:hover {
    border-color: var(--primary);
    background: var(--primary-lighter);
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(59, 130, 246, 0.1);
}
.location-item.active {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    border-color: var(--primary-dark);
    color: white;
    box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
}
.location-item.active .item-text,
.location-item.active .item-arrow {
    color: white;
}
.item-text {
    font-size: 1rem;
    font-weight: 500;
    color: var(--text-primary);
}
.item-arrow {
    color: var(--text-muted);
    font-weight: 600;
}

/* Loading State */
.loading-section {
    text-align: center;
    padding: 2rem;
    color: var(--text-muted);
}
.loading-spinner {
    width: 30px;
    height: 30px;
    border: 3px solid var(--border);
    border-top: 3px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 0.5rem;
}
@keyframes spin { 100% { transform: rotate(360deg); } }
.empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 2rem;
    color: var(--text-muted);
}

/* Responsive Overrides for Modal */
@media (max-width: 768px) {
    .market-modal {
        top: 0;
        left: 0;
        transform: translate(0, 0);
        width: 100vw;
        height: 100vh;
        max-height: 100vh;
        border-radius: 0;
    }
    .market-page-content {
        max-height: calc(100vh - 58px);
        padding-bottom: 0;
    }
    .main-container-modal {
        padding: 1rem;
    }
    .items-grid {
        grid-template-columns: 1fr;
        padding: 1rem;
    }
    .selection-summary-modal {
        flex-direction: column;
        align-items: flex-start;
    }
    .summary-item {
        width: 100%;
        justify-content: space-between;
    }
    .quick-actions-modal {
        width: 100%;
        justify-content: space-between;
    }
}
</style>
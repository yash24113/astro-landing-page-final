---
interface Props {
  /** Which edge to dock the launcher on */
  side?: "left" | "right";
  /** Bottom offset so it clears WhatsApp etc. (e.g. "6rem") */
  offsetBottom?: string;
  /** Tooltip/aria label */
  label?: string;
  /** The on-page section id to show inside the modal (your ContactSection root id) */
  targetId?: string;
  /** Optional: override modal max width / height (CSS lengths) */
  maxWidth?: string;
  maxHeight?: string;
}

const {
  side = "right",
  offsetBottom = "6rem",
  label = "Open contact",
  targetId = "contact",
  maxWidth = "min(92vw, 1200px)",
  maxHeight = "min(90vh, 800px)",
} = Astro.props as Props;
---

<!-- Floating launcher -->
<button
  id="contact-fab"
  class={`fab ${side === "right" ? "fab--right" : "fab--left"}`}
  style={`bottom: ${offsetBottom};`}
  aria-label={label}
  title={label}
  aria-haspopup="dialog"
  aria-expanded="false"
>
  <span class="fab__ripple" aria-hidden="true"></span>
  <span class="fab__icon" aria-hidden="true">âœ‰</span>
</button>

<!-- Modal -->
<dialog
  id="contact-dialog"
  class="sheet"
  data-target-id={targetId}
  style={`--sheet-w: ${maxWidth}; --sheet-h: ${maxHeight};`}
>
  <div class="sheet__card" role="document">
    <button class="sheet__close" data-close aria-label="Close">
      <svg viewBox="0 0 24 24" class="x" aria-hidden="true">
        <path d="M18 6L6 18M6 6l12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>

    <!-- Centered, padded, scrollable body -->
    <div class="sheet__body">
      <div id="contact-modal-mount" class="sheet__content"></div>
    </div>
  </div>
</dialog>

<style>
  :root{
    --brand: var(--tp-theme-primary, #2C4C97);
    --brand-light: color-mix(in srgb, var(--brand) 10%, white);
    --brand-lighter: color-mix(in srgb, var(--brand) 5%, white);
    --radius: 16px;
    --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
    --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
  }

  /* ===== FAB ===== */
  .fab{
    position: fixed;
    bottom: var(--fab-bottom, 5.5rem);
    width: clamp(3.25rem, 6vw, 3.75rem);
    height: clamp(3.25rem, 6vw, 3.75rem);
    display: grid;
    place-items: center;
    border: none;
    border-radius: 999px;
    color: #fff;
    cursor: pointer;
    z-index: 9999;
    background: linear-gradient(135deg, var(--brand), color-mix(in oklab, var(--brand) 70%, black));
    box-shadow: 0 .9rem 1.6rem color-mix(in oklab, var(--brand) 35%, transparent);
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .fab:hover {
    transform: translateY(-2px);
    box-shadow: 0 1.2rem 2rem color-mix(in oklab, var(--brand) 45%, transparent);
  }
  
  .fab--right{ 
    right: clamp(1rem, 3vw, 1.5rem); 
  }
  
  .fab--left { 
    left: clamp(1rem, 3vw, 1.5rem); 
  }
  
  .fab__icon{ 
    font-size: 1.4rem; 
    position: relative; 
    z-index: 1; 
  }
  
  .fab__ripple{
    position: absolute;
    inset: 0;
    border-radius: inherit;
    pointer-events: none;
    background: #fff;
    opacity: 0;
    transform: scale(1);
    transition: opacity .25s ease, transform .25s ease;
  }
  
  .fab:hover .fab__ripple{ 
    opacity: .15; 
    transform: scale(1.2); 
  }

  /* ===== SHEET (dialog) ===== */
  .sheet{ 
    border: none; 
    padding: 0; 
    background: transparent; 
    margin: auto; 
    width: var(--sheet-w);
    max-width: 96vw;
    animation: fadeIn 0.3s ease-out;
  }
  
  .sheet::backdrop{ 
    background: rgb(15 23 42 / .55); 
    backdrop-filter: blur(.2rem);
    animation: fadeIn 0.3s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .sheet__card{
    width: 100%;
    max-height: var(--sheet-h);
    background: #fff;
    border-radius: clamp(14px, 2vw, 18px);
    box-shadow: var(--shadow-lg);
    position: relative;
    overflow: hidden;
    display: grid;
    grid-template-rows: 1fr;
    animation: slideUp 0.3s ease-out;
  }

  @keyframes slideUp {
    from { 
      opacity: 0;
      transform: translateY(20px);
    }
    to { 
      opacity: 1;
      transform: translateY(0);
    }
  }

  .sheet__close{
    position: absolute;
    right: .65rem;
    top: .65rem;
    width: 2.25rem;
    height: 2.25rem;
    display: grid;
    place-items: center;
    border: 1px solid rgb(2 6 23 / .08);
    background: #fff;
    border-radius: 10px;
    cursor: pointer;
    z-index: 2;
    transition: all 0.2s ease;
  }
  
  .sheet__close:hover{ 
    background: #f8fafc; 
    transform: scale(1.05);
    box-shadow: var(--shadow-sm);
  }
  
  .x{ 
    width: 1.1rem; 
    height: 1.1rem; 
  }

  /* ===== Centered scroll frame ===== */
  .sheet__body{
    box-sizing: border-box;
    --side-pad: clamp(16px, 2vw, 24px);
    scrollbar-gutter: stable both-edges;
    max-height: var(--sheet-h);
    overflow-y: auto;
    overflow-x: hidden;
    display: flex;
    justify-content: center;
    align-items: flex-start;
  }

  .sheet__content{
    width: 100%;
    max-width: 100%;
    margin: 0 auto;
    box-sizing: border-box;
  }

  /* Reset contact section styles for modal */
  .sheet :where(.contact-wrap){
    min-height: unset !important;
    padding: 0 !important;
    margin: 0 !important;
    width: 100% !important;
    box-sizing: border-box !important;
    background: none !important;
    overflow: visible !important;
  }

  .sheet :where(.floating-shapes) {
    display: none !important;
  }

  .sheet :where(.contact-wrap .container){
    box-sizing: border-box !important;
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 auto !important;
    padding-inline: 0 !important;
    overflow: visible !important;
  }

  .sheet :where(.contact-wrap .grid){
    display: grid !important;
    grid-template-columns: minmax(0, 1fr) minmax(0, 1fr) !important;
    gap: clamp(20px, 2vw, 28px) !important;
    align-items: start !important;
    width: 100% !important;
    box-sizing: border-box !important;
  }

  @media (max-width: 968px){
    .sheet{ 
      width: min(94vw, 700px) !important; 
    }
    
    .sheet :where(.contact-wrap .grid){ 
      grid-template-columns: 1fr !important; 
    }
  }
</style>

<script is:inline>
// Enhanced modal functionality with better error handling
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded - initializing contact modal...');
  
  const fab = document.getElementById('contact-fab');
  const dialog = document.getElementById('contact-dialog');
  const mount = document.getElementById('contact-modal-mount');
  
  console.log('Elements found:', { fab, dialog, mount });
  
  if (!fab || !dialog || !mount) {
    console.error('Required elements not found:', {
      fab: !!fab,
      dialog: !!dialog,
      mount: !!mount
    });
    return;
  }

  // Check if dialog supports showModal
  if (typeof dialog.showModal !== 'function') {
    console.error('Dialog element does not support showModal method');
    fab.style.display = 'none'; // Hide FAB if not supported
    return;
  }

  const targetId = dialog.dataset.targetId || 'contact';
  const contactSection = document.getElementById(targetId);
  
  console.log('Contact section:', contactSection);
  
  if (!contactSection) {
    console.error(`Contact section with id "${targetId}" not found`);
    fab.style.display = 'none';
    return;
  }

  let placeholder = null;
  let originalParent = null;
  let originalNextSibling = null;

  function openModal() {
    console.log('Opening modal...');
    
    try {
      // Store original position
      originalParent = contactSection.parentNode;
      originalNextSibling = contactSection.nextSibling;

      // Create placeholder to maintain layout
      placeholder = document.createElement('div');
      const rect = contactSection.getBoundingClientRect();
      placeholder.style.height = rect.height + 'px';
      placeholder.setAttribute('aria-hidden', 'true');
      originalParent.insertBefore(placeholder, contactSection);

      // Move section to modal
      mount.appendChild(contactSection);
      
      // Show modal
      dialog.showModal();
      fab.setAttribute('aria-expanded', 'true');
      document.documentElement.style.overflow = 'hidden';

      console.log('Modal opened successfully');

      // Focus first input field
      setTimeout(() => {
        const firstInput = contactSection.querySelector('input, select, textarea, button');
        if (firstInput && firstInput.focus) {
          firstInput.focus();
        }
      }, 100);

    } catch (error) {
      console.error('Error opening modal:', error);
    }
  }

  function closeModal() {
    console.log('Closing modal...');
    
    try {
      // Move section back to original position
      if (originalParent && contactSection.parentNode === mount) {
        if (originalNextSibling) {
          originalParent.insertBefore(contactSection, originalNextSibling);
        } else {
          originalParent.appendChild(contactSection);
        }
      }

      // Remove placeholder
      if (placeholder && placeholder.parentNode) {
        placeholder.parentNode.removeChild(placeholder);
      }

      // Reset variables
      placeholder = null;
      originalParent = null;
      originalNextSibling = null;

      // Close modal
      dialog.close();
      fab.setAttribute('aria-expanded', 'false');
      document.documentElement.style.overflow = '';
      
      // Return focus to FAB
      fab.focus();

      console.log('Modal closed successfully');

    } catch (error) {
      console.error('Error closing modal:', error);
    }
  }

  // Event listeners
  fab.addEventListener('click', openModal);
  
  dialog.addEventListener('cancel', (event) => {
    event.preventDefault();
    closeModal();
  });

  dialog.addEventListener('click', (event) => {
    if (event.target === dialog) {
      closeModal();
    }
  });

  const closeButton = dialog.querySelector('[data-close]');
  if (closeButton) {
    closeButton.addEventListener('click', closeModal);
  }

  // Close on Escape key
  document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape' && dialog.open) {
      closeModal();
    }
  });

  console.log('Contact modal initialized successfully');
});

// Also initialize on Astro page load
document.addEventListener('astro:page-load', function() {
  console.log('Astro page load - reinitializing contact modal...');
  // Re-run the initialization
  document.dispatchEvent(new Event('DOMContentLoaded'));
});
</script>
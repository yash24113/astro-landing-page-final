---
/* src/components/sections/Testimonials.astro */

type TItem = {
  id: number; review: number; desc: string; industry: string; location: string; tags: string[];
};

const DATA: TItem[] = [
  { id: 1, review: 5,   desc: 'Fabric inspection reports and test certificates provided on request. Helped us pass third-party audits without issues.', industry: 'Export Compliance Partner', location: 'Jaipur, RJ', tags: ['Reports', 'Certificates', 'Compliance'] },
  { id: 2, review: 4.5, desc: 'On-time dispatch for 10K+ meters/month with stable hand-feel on peach finish poplin. Shade lots stayed consistent across repeats.', industry: 'Garment Exporter', location: 'Tirupur, TN', tags: ['Online Delivery', 'Peach Finish', 'Bulk Orders'] },
  { id: 3, review: 5,   desc: 'Uniform shirting quality is predictable. GSM and shrinkage are under control which reduced our returns dramatically.', industry: 'Uniform Manufacturer', location: 'Ludhiana, Punjab', tags: ['GSM Control', 'Shrinkage', 'Low Returns'] },
];

/* duplicate to 6 so the radio carousel has multiple pages everywhere */
const ITEMS: TItem[] = DATA.length <= 3
  ? Array.from({ length: 6 }, (_, i) => ({ ...DATA[i % DATA.length], id: i + 1 }))
  : DATA;

const metrics = [
  { k: 'REPEAT ORDERS',    v: '96%'  },
  { k: 'ON-TIME',          v: '99.2%' },
  { k: 'MONTHLY VOLUME',   v: '10K+' },
  { k: 'CLIENT RETENTION', v: '98%'  },
];

const pagesBase = ITEMS.length;                 // mobile: 1 card per view
const pagesSm   = Math.ceil(ITEMS.length / 2);  // tablet: 2 per view
const pagesLg   = Math.ceil(ITEMS.length / 3);  // desktop: 3 per view

// tablet / desktop rules (track translate)
function makePagedRules(prefix: 's'|'l', pages: number) {
  return Array.from({ length: pages }, (_, i) => `
#tc-${prefix}-${i+1}:checked ~ .viewport .track{transform:translateX(-${i*100}%);}
#tc-${prefix}-${i+1}:checked ~ .dots.${prefix} label[for="tc-${prefix}-${i+1}"]{background:var(--gold);transform:scale(1.25);}
`).join('\n');
}

// mobile rules: show ONLY 1 slide (no peek of next)
const mobileRules = Array.from({ length: pagesBase }, (_, i) => `
#tc-b-${i+1}:checked ~ .viewport .slides .slide{display:none;}
#tc-b-${i+1}:checked ~ .viewport .slides .slide:nth-child(${i+1}){display:block;}
#tc-b-${i+1}:checked ~ .dots.b label[for="tc-b-${i+1}"]{background:var(--gold);transform:scale(1.25);}
`).join('\n');

/* injected CSS */
const injected = `
@media (max-width:639.98px){
${mobileRules}
}
@media (min-width:640px) and (max-width:1023.98px){
${makePagedRules('s', pagesSm)}
}
@media (min-width:1024px){
${makePagedRules('l', pagesLg)}
}
`;
---

<section id="testimonials" class="age-testi full-bleed compact" aria-labelledby="age-testi-title">
  <div class="age-wrap">
    <div class="age-head">
      <div class="eyebrow">WHAT OUR CUSTOMERS SAY</div>
      <span class="badge"><i></i>Verified Industry Feedback</span>
      <h2 id="age-testi-title" class="title">Trusted by Fabric Buyers</h2>
    </div>

    <div class="slider-wrap">
      <div class="carousel" id="tc">
        {/* radios */}
        {Array.from({length: pagesBase}).map((_, i) => (
          <input
            class="nav-radio base"
            type="radio"
            name="tc-b"
            id={`tc-b-${i+1}`}
            checked={i===0}
            aria-label={`Show slide ${i+1} (mobile)`}
          />
        ))}
        {Array.from({length: pagesSm}).map((_, i) => (
          <input
            class="nav-radio sm"
            type="radio"
            name="tc-s"
            id={`tc-s-${i+1}`}
            checked={i===0}
            aria-label={`Show slide ${i+1} (tablet)`}
          />
        ))}
        {Array.from({length: pagesLg}).map((_, i) => (
          <input
            class="nav-radio lg"
            type="radio"
            name="tc-l"
            id={`tc-l-${i+1}`}
            checked={i===0}
            aria-label={`Show slide ${i+1} (desktop)`}
          />
        ))}

        <div class="viewport">
          <div class="track">
            <ul class="slides" role="list">
              {ITEMS.map((item) => (
                <li class="slide">
                  <article class="card">
                    <div class="top">
                      <div
                        class="stars"
                        role="img"
                        aria-label={`${Number(item.review.toFixed(1))} out of 5 stars`}
                      >
                        {Array.from({ length: 5 }).map((_, i) => (
                          <svg
                            aria-hidden="true"
                            width="16" height="16" viewBox="0 0 24 24"
                            fill={i < Math.floor(item.review) ? 'currentColor' : 'none'}
                            stroke="currentColor"
                          >
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.85L18.18 22 12 18.77 5.82 22 7 14.12l-5-4.85 6.91-1.01L12 2z"/>
                          </svg>
                        ))}
                      </div>

                      <span class="verified">
                        <svg width="12" height="12" viewBox="0 0 24 24" aria-hidden="true">
                          <path d="M12 2l3.09 6.26L22 9.27l-5 4.85L18.18 22 12 18.77 5.82 22 7 14.12l-5-4.85 6.91-1.01L12 2z"/>
                        </svg>
                        VERIFIED
                      </span>
                    </div>

                    <p class="quote">“{item.desc}”</p>

                    <div class="client">
                      <div class="industry">{item.industry}</div>
                      <div class="dot"></div>
                      <div class="loc">{item.location}</div>
                    </div>

                    <div class="tags" aria-label="tags">
                      {item.tags.slice(0,3).map((t) => (<span class="chip">{t}</span>))}
                    </div>
                  </article>
                </li>
              ))}
            </ul>
          </div>
        </div>

        {/* Dots */}
        <div class="dots b" aria-label="carousel pagination (mobile)">
          {Array.from({length: pagesBase}).map((_, i) => (
            <label for={`tc-b-${i+1}`} class="dot" aria-label={`Go to slide ${i+1}`}></label>
          ))}
        </div>
        <div class="dots s" aria-label="carousel pagination (tablet)">
          {Array.from({length: pagesSm}).map((_, i) => (
            <label for={`tc-s-${i+1}`} class="dot" aria-label={`Go to page ${i+1}`}></label>
          ))}
        </div>
        <div class="dots l" aria-label="carousel pagination (desktop)">
          {Array.from({length: pagesLg}).map((_, i) => (
            <label for={`tc-l-${i+1}`} class="dot" aria-label={`Go to page ${i+1}`}></label>
          ))}
        </div>
      </div>
    </div>

    <div class="metrics">
      {metrics.map((m) => (
        <div class="mcard">
          <div class="val">{m.v}</div>
          <div class="key">{m.k}</div>
        </div>
      ))}
    </div>
  </div>

  <style>
    /* Full width band */
    .full-bleed{ width:100vw; margin-left:calc(50% - 50vw); }

    .age-testi{
      background: var(--tp-theme-1, #112338);
      padding: clamp(22px, 3.5vw, 36px) 0 clamp(18px, 3vw, 28px);
      color: var(--tp-common-white, #fff);
      --gold: var(--tp-theme-secondary, #D6A74B);
      --blue: var(--tp-theme-primary, #2C4C97);
      --soft: rgba(255,255,255,.75);
      -webkit-tap-highlight-color: transparent;
    }
    .age-wrap{ max-width:1200px; margin:0 auto; padding:0 16px; }

    .age-head{ text-align:center; margin-bottom: 14px; }
    .eyebrow{ color: var(--soft); font-weight:800; letter-spacing:.18em; font-size:.68rem; }
    .badge{
      display:inline-flex; align-items:center; gap:6px; margin-top:6px;
      padding:5px 10px; border-radius:999px; color:var(--gold);
      border:1px solid color-mix(in srgb, var(--gold) 26%, transparent);
      background: color-mix(in srgb, var(--gold) 10%, transparent);
      font-weight:700; font-size:.68rem; text-transform:uppercase;
    }
    .badge i{ width:6px; height:6px; border-radius:999px; background:var(--gold); }
    .title{ margin-top:8px; font-weight:800; letter-spacing:.3px; font-size: clamp(24px, 2.6vw, 34px); }

    /* Cards */
    .card{
      display:flex; flex-direction:column; height:100%;
      background:#fff; color:#0f2235; border-radius:12px; padding:clamp(12px,2.8vw,14px);
      border:1px solid color-mix(in srgb, #e5ebf3 45%, transparent);
      box-shadow:0 8px 20px rgba(0,0,0,.10);
      position:relative; box-sizing:border-box;
    }
    .card::after{ content:''; position:absolute; inset:0; border-radius:12px; box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--gold) 20%, transparent); pointer-events:none; }

    .top{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .stars{ color: var(--gold); display:flex; gap:1px; }
    .verified{
      display:inline-flex; gap:6px; align-items:center;
      padding:5px 8px; border-radius:999px;
      font-weight:800; font-size:.7rem; line-height:1;
      background: var(--AGE-GOLD-BG-SOFT, #FFF4CC);
      border:1px solid var(--tp-theme-secondary, #D6A74B);
      color: var(--AGE-GOLD-INK-AA, #6B5316);
    }
    .verified svg{ width:12px; height:12px; fill: currentColor; display:block; }

    .quote{ margin:8px 0 10px; line-height:1.5; font-weight:500; min-height:48px; }
    @media (max-width: 420px){ .quote{ min-height: 0; } }

    .client{ display:flex; align-items:center; gap:6px; margin-bottom:8px; flex-wrap:wrap; row-gap:4px; }
    .industry{ color: var(--blue); font-weight:800; font-size:.95rem; }
    .loc{ color:#5c6a80; font-weight:700; font-size:.82rem; }
    .dot{ width:4px; height:4px; border-radius:999px; background:#cfd6e4; opacity:.8; }

    .tags{ display:flex; gap:6px; flex-wrap:wrap; margin-top:2px; }
    .chip{ padding:4px 8px; border-radius:16px; background:#f3f6fb; border:1px solid #e1e7f0; color:#4b5a70; font-weight:700; font-size:.72rem; }
    .chip:hover{ background: var(--blue); border-color: var(--blue); color:#fff; }

    /* Metrics */
    .metrics{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-top:16px; }
    .mcard{ text-align:center; border-radius:10px; background:#00000033; padding:12px 10px; box-shadow:0 6px 14px rgba(0,0,0,.10); color:var(--gold); }
    .mcard .val{ font-weight:900; font-size:18px; margin-bottom:4px; }
    .mcard .key{ font-weight:800; font-size:.74rem; letter-spacing:.04em; color: color-mix(in srgb, var(--gold) 84%, #fff); }
    @media (max-width:639.98px){
      .metrics{ grid-template-columns: repeat(2,1fr); }
      .mcard .val{ font-size:17px; }
    }

    /* ===== Radio carousel ===== */
    .carousel{ position:relative; overflow:hidden; }
    .nav-radio{ position:absolute; opacity:0; pointer-events:none; }

    .viewport{ overflow:clip; overscroll-behavior:contain; }
    @media (max-width:639.98px){ .viewport{ padding-inline:16px; } }

    .track{
      width:100%;
      transition: transform 360ms ease;
      will-change: transform;
    }

    .slides{
      display:flex;
      --gap: clamp(0.5rem, 1.6vw, 0.75rem);
      gap: var(--gap);
      padding-bottom: 46px;
      list-style:none; margin:0;
      align-items: stretch;
    }
    @media (max-width:639.98px){
      .slides{
        display:block;   /* stack, then we hide all but selected */
        gap:0;
      }
    }

    .slide{ flex: 0 0 100%; min-width:0; }
    @media (max-width:639.98px){
      .slide{
        flex:none;
        width:100%;
      }
    }
    @media (min-width:640px){
      .slide{ flex-basis: calc((100% - var(--gap)) / 2); }
    }
    @media (min-width:1024px){
      .slide{ flex-basis: calc((100% - (var(--gap) * 2)) / 3); }
    }

    .dots{ position:absolute; left:50%; transform:translateX(-50%); bottom:8px; display:flex; gap:10px; z-index:3; }
    .dots .dot{ width:8px; height:8px; border-radius:999px; display:block; background: rgba(255,255,255,.38); outline:2px solid transparent; cursor:pointer; }
    .dots .dot:focus-visible{ outline-color: var(--gold); }
    .dots.b{ display:flex; }
    .dots.s, .dots.l{ display:none; }
    @media (min-width:640px){ .dots.b{display:none;} .dots.s{display:flex;} }
    @media (min-width:1024px){ .dots.s{display:none;} .dots.l{display:flex;} }

    .sr-only{
      position:absolute!important;
      width:1px;height:1px;margin:-1px;padding:0;border:0;
      clip:rect(0 0 0 0);clip-path:inset(50%);overflow:hidden;
      white-space:nowrap;
    }
  </style>

  {/* dynamic transform / active-dot CSS */}
  <style is:global set:html={injected}></style>
</section>
